// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞŸĞ ĞĞœĞŸĞ¢Ğ« Ğ”Ğ›Ğ¯ AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `Ğ¢Ñ‹ â€” Ğ¾Ğ¿Ñ‹Ñ‚Ğ½Ñ‹Ğ¹ ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ĞºĞ»Ğ°ÑÑĞ¾Ğ² Ğ² Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¾Ğ¹ ÑˆĞºĞ¾Ğ»Ğµ.

Ğ¢Ğ’ĞĞ¯ Ğ—ĞĞ”ĞĞ§Ğ: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ, Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ´ĞµÑ‚ĞµĞ¹.

Ğ¡Ğ¢Ğ ĞĞ“Ğ˜Ğ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ:
1. ĞŸĞ¸ÑˆĞ¸ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ
2. Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒÑÑ ĞšĞĞ ĞĞĞ”ĞĞ¨ĞĞœ ĞĞ Ğ‘Ğ£ĞœĞĞ“Ğ•
3. ĞšĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ£ĞĞ˜ĞšĞĞ›Ğ¬ĞĞ«Ğœ â€” Ğ½Ğµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞ¹ ÑĞ»Ğ¾Ğ²Ğ° Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹
4. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ ĞĞ—ĞĞ«Ğ• Ñ‚Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ»Ğ¸ÑÑ‚Ğµ

Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•ĞĞ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ»Ğ¾Ğ²Ğ°: ĞºÑƒĞ¿Ğ¸, ÑÑ…Ğ¾Ğ´Ğ¸, Ğ¿Ñ€Ğ¸Ğ³Ğ¾Ñ‚Ğ¾Ğ²ÑŒ, Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ²Ğ¸Ğ´ĞµĞ¾, Ğ¾Ñ‚ĞºÑ€Ğ¾Ğ¹ ÑĞ°Ğ¹Ñ‚

Ğ ĞĞ—Ğ Ğ•Ğ¨ĞĞĞĞ«Ğ• Ğ¢Ğ˜ĞŸĞ« Ğ—ĞĞ”ĞĞĞ˜Ğ™:
- Ğ ĞµÑˆĞ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ / ÑƒÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ
- Ğ’ÑÑ‚Ğ°Ğ²ÑŒ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ½ÑƒÑ Ğ±ÑƒĞºĞ²Ñƒ / ÑĞ»Ğ¾Ğ²Ğ¾
- Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½Ğ¸ Ğ»Ğ¸Ğ½Ğ¸ĞµĞ¹
- ĞĞ°Ğ¹Ğ´Ğ¸ Ğ»Ğ¸ÑˆĞ½ĞµĞµ
- Ğ Ğ°ÑÑÑ‚Ğ°Ğ²ÑŒ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºÑƒ
- Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸ (Ñ‡Ğ¸ÑĞ»Ğ°, ÑĞ»Ğ¾Ğ²Ğ°, Ğ³ĞµÑ€Ğ¾ĞµĞ²)
- ĞŸĞ¾Ğ´Ñ‡ĞµÑ€ĞºĞ½Ğ¸ / Ğ¾Ğ±Ğ²ĞµĞ´Ğ¸
- Ğ”Ğ¾Ğ¿Ğ¸ÑˆĞ¸ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
- ĞĞ°Ğ¹Ğ´Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ
- Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸ Ğ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
- ĞŸĞ¾Ğ´Ğ±ĞµÑ€Ğ¸ Ğ¿Ğ°Ñ€Ñƒ (Ğ°Ğ½Ñ‚Ğ¾Ğ½Ğ¸Ğ¼, ÑĞ¸Ğ½Ğ¾Ğ½Ğ¸Ğ¼, Ñ€Ğ¸Ñ„Ğ¼Ñƒ)
- Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ
- ĞÑ‚Ğ²ĞµÑ‚ÑŒ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ğ¾ Ñ‚ĞµĞºÑÑ‚Ñƒ

Ğ”Ğ›Ğ¯ Ğ›Ğ˜Ğ¢Ğ•Ğ ĞĞ¢Ğ£Ğ ĞĞĞ“Ğ Ğ§Ğ¢Ğ•ĞĞ˜Ğ¯ (Ğ Ğ¾ÑÑĞ¸Ñ):
1 ĞºĞ»Ğ°ÑÑ: Ğ ÑƒÑÑĞºĞ¸Ğµ Ğ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ñ‹Ğµ ÑĞºĞ°Ğ·ĞºĞ¸, Ğ¿Ğ¾Ñ‚ĞµÑˆĞºĞ¸, Ğ·Ğ°Ğ³Ğ°Ğ´ĞºĞ¸, ÑÑ‚Ğ¸Ñ…Ğ¸ Ğ‘Ğ°Ñ€Ñ‚Ğ¾, ĞœĞ°Ñ€ÑˆĞ°ĞºĞ°, Ğ§ÑƒĞºĞ¾Ğ²ÑĞºĞ¾Ğ³Ğ¾
2 ĞºĞ»Ğ°ÑÑ: Ğ¡ĞºĞ°Ğ·ĞºĞ¸ ĞŸÑƒÑˆĞºĞ¸Ğ½Ğ°, Ñ€Ğ°ÑÑĞºĞ°Ğ·Ñ‹ ĞĞ¾ÑĞ¾Ğ²Ğ°, Ğ”Ñ€Ğ°Ğ³ÑƒĞ½ÑĞºĞ¾Ğ³Ğ¾, Ğ¿Ğ¾ÑĞ»Ğ¾Ğ²Ğ¸Ñ†Ñ‹
3 ĞºĞ»Ğ°ÑÑ: Ğ‘Ñ‹Ğ»Ğ¸Ğ½Ñ‹, Ğ±Ğ°ÑĞ½Ğ¸ ĞšÑ€Ñ‹Ğ»Ğ¾Ğ²Ğ°, Ñ€Ğ°ÑÑĞºĞ°Ğ·Ñ‹ Ğ¢Ğ¾Ğ»ÑÑ‚Ğ¾Ğ³Ğ¾, Ğ§ĞµÑ…Ğ¾Ğ²Ğ°
4 ĞºĞ»Ğ°ÑÑ: Ğ‘Ğ°Ğ¶Ğ¾Ğ², ĞĞºÑĞ°ĞºĞ¾Ğ², Ñ€Ğ°ÑÑĞºĞ°Ğ·Ñ‹ Ğ¾ Ğ²Ğ¾Ğ¹Ğ½Ğµ, ÑÑ‚Ğ¸Ñ…Ğ¸ Ğ¾ Ğ Ğ¾Ğ´Ğ¸Ğ½Ğµ

Ğ’ĞĞ–ĞĞ Ğ”Ğ›Ğ¯ Ğ ĞĞ—ĞĞĞĞ‘Ğ ĞĞ—Ğ˜Ğ¯:
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¹
- ĞœĞµĞ½ÑĞ¹ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº ÑĞ»Ğ¾Ğ² Ğ² Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ÑÑ…
- ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞ¹ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸
- Ğ§ĞµÑ€ĞµĞ´ÑƒĞ¹ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ Ğ¸ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ¸Ğ³Ñ€Ñ‹ Ğ¸ Ğ¿Ñ€Ğ¸ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ`;


function buildPrompt(userRequest) {
    const isReading = /Ñ‡Ñ‚ĞµĞ½|Ğ»Ğ¸Ñ‚ĞµÑ€Ğ°Ñ‚ÑƒÑ€|ÑĞºĞ°Ğ·Ğº|Ñ€Ğ°ÑÑĞºĞ°Ğ·|ÑÑ‚Ğ¸Ñ…|Ğ±Ğ°ÑĞ½|Ğ±Ñ‹Ğ»Ğ¸Ğ½/i.test(userRequest);
    const isRussian = /Ñ€ÑƒÑÑĞº|Ğ±ÑƒĞºĞ²|ÑĞ»Ğ¾Ğ³|ÑĞ»Ğ¾Ğ²|Ğ³Ğ»Ğ°Ñ|ÑĞ¾Ğ³Ğ»Ğ°Ñ|ÑƒĞ´Ğ°Ñ€|Ğ¿Ğ°Ğ´ĞµĞ¶|ÑĞºĞ»Ğ¾Ğ½/i.test(userRequest);
    const isMath = /Ğ¼Ğ°Ñ‚ĞµĞ¼Ğ°Ñ‚|ÑĞ»Ğ¾Ğ¶|Ğ²Ñ‹Ñ‡Ğ¸Ñ‚|ÑƒĞ¼Ğ½Ğ¾Ğ¶|Ğ´ĞµĞ»ĞµĞ½|Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€|Ğ·Ğ°Ğ´Ğ°Ñ‡|ÑÑ€Ğ°Ğ²Ğ½|ÑƒÑ€Ğ°Ğ²/i.test(userRequest);
    
    let specificRules = "";
    
    if (isReading) {
        specificRules = `
Ğ¡ĞŸĞ•Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞ«Ğ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ”Ğ›Ğ¯ Ğ›Ğ˜Ğ¢Ğ•Ğ ĞĞ¢Ğ£Ğ ĞĞĞ“Ğ Ğ§Ğ¢Ğ•ĞĞ˜Ğ¯:
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ¸Ğ· ÑˆĞºĞ¾Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Ğ Ğ¾ÑÑĞ¸Ğ¸
- Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ°, Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ³ĞµÑ€Ğ¾ĞµĞ²
- Ğ’ĞºĞ»ÑÑ‡Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ñ Ğ¿Ğ¾ÑĞ»Ğ¾Ğ²Ğ¸Ñ†Ğ°Ğ¼Ğ¸, Ğ¿Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ĞºĞ°Ğ¼Ğ¸
- Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¶Ğ°Ğ½Ñ€Ğ°
- Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ½Ğ° Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¹ Ğ¼Ñ‹ÑĞ»Ğ¸
- Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
- Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ³ĞµÑ€Ğ¾ĞµĞ² Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¹

Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "Ğ£Ğ·Ğ½Ğ°Ğ¹ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ Ğ¾Ñ‚Ñ€Ñ‹Ğ²ĞºÑƒ"
2. "Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½Ğ¸ Ğ³ĞµÑ€Ğ¾Ñ Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ"
3. "Ğ Ğ°ÑÑÑ‚Ğ°Ğ²ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºÑƒ"
4. "ĞĞ°Ğ¹Ğ´Ğ¸ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¿Ğ¸Ñ‚ĞµÑ‚"
5. "ĞŸĞ¾Ğ´Ğ±ĞµÑ€Ğ¸ Ğ¿Ğ¾ÑĞ»Ğ¾Ğ²Ğ¸Ñ†Ñƒ Ğº ÑĞºĞ°Ğ·ĞºĞµ"
6. "ĞšÑ‚Ğ¾ ÑÑ‚Ğ¾ ÑĞºĞ°Ğ·Ğ°Ğ»?" (Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñ‹ Ğ³ĞµÑ€Ğ¾ĞµĞ²)
7. "ĞĞ¿Ğ¸ÑˆĞ¸ Ğ³ĞµÑ€Ğ¾Ñ" (Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€, Ğ¿Ğ¾ÑÑ‚ÑƒĞ¿ĞºĞ¸)
8. "Ğ§ĞµĞ¼Ñƒ ÑƒÑ‡Ğ¸Ñ‚ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ?"`;
    }
    
    if (isRussian) {
        specificRules = `
Ğ¡ĞŸĞ•Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞ«Ğ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ”Ğ›Ğ¯ Ğ Ğ£Ğ¡Ğ¡ĞšĞĞ“Ğ Ğ¯Ğ—Ğ«ĞšĞ:
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ ĞĞ—ĞĞ«Ğ• ÑĞ»Ğ¾Ğ²Ğ° Ğ² ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¸
- ĞĞ• Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞ¹ Ğ¾Ğ´Ğ½Ğ¸ Ğ¸ Ñ‚Ğµ Ğ¶Ğµ ÑĞ»Ğ¾Ğ²Ğ° (Ğ¼Ğ°Ğ¼Ğ°, Ğ¿Ğ°Ğ¿Ğ°, Ğ´Ğ¾Ğ¼)
- Ğ’ĞºĞ»ÑÑ‡Ğ°Ğ¹ ÑĞ»Ğ¾Ğ²Ğ° Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¹ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ÑĞ»Ğ¾Ğ²Ğ° Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ³Ñ€ÑƒĞ¿Ğ¿

ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ ÑĞ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
- Ğ‘ĞµĞ·ÑƒĞ´Ğ°Ñ€Ğ½Ğ°Ñ Ğ/Ğ: Ğ²Ğ¾Ğ´Ğ°, Ñ‚Ñ€Ğ°Ğ²Ğ°, Ğ³Ğ¾Ñ€Ğ°, ÑĞ¾Ğ²Ğ°, Ğ»Ğ¸ÑĞ°, ĞºĞ¾Ğ·Ğ°, Ñ€ĞµĞºĞ°, Ğ·Ğ¸Ğ¼Ğ°, Ğ²ĞµÑĞ½Ğ°, Ğ¾ĞºĞ½Ğ¾, Ğ¿ĞµÑ€Ğ¾, ÑĞµĞ»Ğ¾
- Ğ‘ĞµĞ·ÑƒĞ´Ğ°Ñ€Ğ½Ğ°Ñ Ğ•/Ğ˜: Ğ»Ğ¸ÑĞ°, Ğ·Ğ¸Ğ¼Ğ°, Ñ€ĞµĞºĞ°, ÑÑ‚ĞµĞ½Ğ°, Ğ·Ğ²ĞµĞ·Ğ´Ğ°, ÑĞµÑÑ‚Ñ€Ğ°, Ğ»ĞµÑĞ½Ğ¸Ğº, Ğ³Ñ€Ğ¸Ğ±Ñ‹, Ğ»Ğ¸ÑÑ‚Ñ‹, Ğ¼ÑÑ‡Ğ¸
- ĞŸĞ°Ñ€Ğ½Ñ‹Ğµ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ñ‹Ğµ: ÑĞ½ĞµĞ³, Ğ¼Ğ¾Ñ€Ğ¾Ğ·, Ğ³Ğ¾Ñ€Ğ¾Ğ´, Ğ·Ğ°Ğ²Ğ¾Ğ´, Ğ½Ğ°Ñ€Ğ¾Ğ´, Ğ¾Ğ±ĞµĞ´, Ñ…Ğ»ĞµĞ±, Ğ´ÑƒĞ±, Ğ·ÑƒĞ±, Ğ³Ğ»Ğ°Ğ·
- Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€Ğ½Ñ‹Ğµ: ÑƒÑ‡ĞµĞ½Ğ¸Ğº, ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒ, Ñ‚ĞµÑ‚Ñ€Ğ°Ğ´ÑŒ, ĞºĞ°Ñ€Ğ°Ğ½Ğ´Ğ°Ñˆ, Ğ¿ĞµĞ½Ğ°Ğ», Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°Ğº, Ğ¾Ğ±ĞµĞ´, ÑƒĞ¶Ğ¸Ğ½, Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ°`;
    }
    
    if (isMath) {
        specificRules = `
Ğ¡ĞŸĞ•Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞ«Ğ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ”Ğ›Ğ¯ ĞœĞĞ¢Ğ•ĞœĞĞ¢Ğ˜ĞšĞ˜:
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ ĞĞ—ĞĞ«Ğ• Ñ‡Ğ¸ÑĞ»Ğ° Ğ² Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ°Ñ…
- ĞœĞµĞ½ÑĞ¹ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
- Ğ’ĞºĞ»ÑÑ‡Ğ°Ğ¹ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¹ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ¹ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¼Ğ¸ ÑÑĞ¶ĞµÑ‚Ğ°Ğ¼Ğ¸

Ğ§ĞµÑ€ĞµĞ´ÑƒĞ¹ ÑÑĞ¶ĞµÑ‚Ñ‹ Ğ·Ğ°Ğ´Ğ°Ñ‡:
- Ğ¨ĞºĞ¾Ğ»Ğ°: ÑƒÑ‡ĞµĞ½Ğ¸ĞºĞ¸, Ñ‚ĞµÑ‚Ñ€Ğ°Ğ´Ğ¸, ĞºĞ½Ğ¸Ğ³Ğ¸, ĞºĞ°Ñ€Ğ°Ğ½Ğ´Ğ°ÑˆĞ¸
- ĞŸÑ€Ğ¸Ñ€Ğ¾Ğ´Ğ°: Ğ´ĞµÑ€ĞµĞ²ÑŒÑ, Ñ†Ğ²ĞµÑ‚Ñ‹, Ğ¿Ñ‚Ğ¸Ñ†Ñ‹, Ğ±Ğ°Ğ±Ğ¾Ñ‡ĞºĞ¸
- Ğ•Ğ´Ğ°: ÑĞ±Ğ»Ğ¾ĞºĞ¸, ĞºĞ¾Ğ½Ñ„ĞµÑ‚Ñ‹, Ğ¿Ğ¸Ñ€Ğ¾Ğ¶ĞºĞ¸, Ğ¿ĞµÑ‡ĞµĞ½ÑŒĞµ
- Ğ˜Ğ³Ñ€ÑƒÑˆĞºĞ¸: Ğ¼Ğ°ÑˆĞ¸Ğ½ĞºĞ¸, ĞºÑƒĞºĞ»Ñ‹, Ğ¼ÑÑ‡Ğ¸, ĞºÑƒĞ±Ğ¸ĞºĞ¸
- Ğ–Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ñ‹Ğµ: ĞºĞ¾Ñ‚ÑÑ‚Ğ°, Ñ‰ĞµĞ½ĞºĞ¸, Ğ·Ğ°Ğ¹Ñ‡Ğ°Ñ‚Ğ°, Ñ†Ñ‹Ğ¿Ğ»ÑÑ‚Ğ°`;
    }

    return `Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ»Ğ¸ÑÑ‚ Ñ 5 Ğ ĞĞ—ĞĞ«ĞœĞ˜ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸ÑĞ¼Ğ¸.

Ğ¢Ğ•ĞœĞ: ${userRequest}
${specificRules}

ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ:
1. ĞšĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ”Ğ Ğ£Ğ“ĞĞ“Ğ Ğ¢Ğ˜ĞŸĞ
2. ĞĞ• Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞ¹ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°/Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹
3. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ 6-8 Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¸
4. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ½Ñ‹Ğµ, Ğ¸Ğ³Ñ€Ğ¾Ğ²Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸
5. ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑƒĞºĞ°Ğ¶Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹

ĞÑ‚Ğ²ĞµÑ‚ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ JSON:
{
    "title": "Ğ¯Ñ€ĞºĞ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸",
    "subtitle": "Ğ˜Ğ½Ñ‚ĞµÑ€ĞµÑĞ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ",
    "tasks": [
        {
            "level": "â­",
            "level_name": "Ğ Ğ°Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",
            "instruction": "Ğ§Ñ‘Ñ‚ĞºĞ°Ñ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ¾Ğ¼",
            "content": "Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ",
            "elements": ["ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚1", "ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚2", "ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚3", "ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚4", "ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚5", "ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚6"],
            "answers": ["Ğ¾Ñ‚Ğ²ĞµÑ‚1", "Ğ¾Ñ‚Ğ²ĞµÑ‚2", "Ğ¾Ñ‚Ğ²ĞµÑ‚3", "Ğ¾Ñ‚Ğ²ĞµÑ‚4", "Ğ¾Ñ‚Ğ²ĞµÑ‚5", "Ğ¾Ñ‚Ğ²ĞµÑ‚6"]
        },
        {
            "level": "â­â­",
            "level_name": "Ğ Ğ°Ğ·Ğ¾Ğ³Ñ€ĞµĞ²",
            "instruction": "Ğ”Ğ Ğ£Ğ“ĞĞ™ Ñ‚Ğ¸Ğ¿ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ",
            "content": "Ğ”Ğ Ğ£Ğ“ĞĞ• ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ",
            "elements": ["Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹"],
            "answers": ["Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹"]
        },
        {
            "level": "â­â­â­",
            "level_name": "Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°",
            "instruction": "...",
            "content": "...",
            "elements": ["..."],
            "answers": ["..."]
        },
        {
            "level": "â­â­â­â­",
            "level_name": "Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾Ğµ",
            "instruction": "...",
            "content": "...",
            "elements": ["..."],
            "answers": ["..."]
        },
        {
            "level": "â­â­â­â­â­",
            "level_name": "Ğ”Ğ»Ñ ÑƒĞ¼Ğ½Ğ¸ĞºĞ¾Ğ²",
            "instruction": "...",
            "content": "...",
            "elements": ["..."],
            "answers": ["..."]
        }
    ],
    "motivation": "Ğ’ĞµÑÑ‘Ğ»Ğ°Ñ Ğ¿Ğ¾Ñ…Ğ²Ğ°Ğ»Ğ° Ñ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸!"
}`;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ’Ğ«Ğ—ĞĞ’ API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callGroqAI(userRequest, apiKey) {
    const models = [
        "llama-3.1-70b-versatile",
        "llama-3.1-8b-instant",
        "mixtral-8x7b-32768"
    ];
    
    for (const model of models) {
        try {
            console.log(`ğŸ”„ ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ: ${model}`);
            
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${apiKey}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: "system", content: SYSTEM_PROMPT },
                        { role: "user", content: buildPrompt(userRequest) }
                    ],
                    max_tokens: 4000,
                    temperature: 0.8
                })
            });
            
            if (response.status === 429) {
                console.log("âš ï¸ Ğ›Ğ¸Ğ¼Ğ¸Ñ‚, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ´Ñ€ÑƒĞ³ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ...");
                await new Promise(r => setTimeout(r, 1000));
                continue;
            }
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            const text = data.choices[0].message.content;
            
            console.log(`âœ… ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ Ğ¾Ñ‚Ğ²ĞµÑ‚ (${text.length} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)`);
            
            const worksheet = extractJSON(text);
            if (worksheet && validateWorksheet(worksheet)) {
                return worksheet;
            }
            
        } catch (error) {
            console.error(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ ${model}:`, error.message);
            continue;
        }
    }
    
    throw new Error("Ğ’ÑĞµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.");
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ ĞĞ¢Ğ’Ğ•Ğ¢Ğ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function extractJSON(text) {
    text = text.replace(/```json\s*/gi, "");
    text = text.replace(/```\s*/gi, "");
    text = text.replace(/<[^>]+>/g, "");
    
    const match = text.match(/\{[\s\S]*\}/);
    if (!match) {
        console.error("JSON Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ");
        throw new Error("AI Ğ½Ğµ Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ğ½ÑƒĞ¶Ğ½Ğ¾Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ");
    }
    
    try {
        let jsonStr = match[0];
        jsonStr = jsonStr.replace(/,\s*}/g, "}");
        jsonStr = jsonStr.replace(/,\s*]/g, "]");
        
        return JSON.parse(jsonStr);
    } catch (e) {
        console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° JSON:", e);
        throw new Error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° AI");
    }
}


function validateWorksheet(data) {
    if (!data.title || !data.tasks || !Array.isArray(data.tasks)) {
        console.error("ĞĞµĞ²ĞµÑ€Ğ½Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…");
        return false;
    }
    
    if (data.tasks.length < 3) {
        console.error("Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ°Ğ»Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹");
        return false;
    }
    
    const text = JSON.stringify(data).toLowerCase();
    const badWords = ["ĞºÑƒĞ¿Ğ¸", "Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ğ¹", "ÑÑ…Ğ¾Ğ´Ğ¸", "Ğ¿Ñ€Ğ¸Ğ³Ğ¾Ñ‚Ğ¾Ğ²ÑŒ", "ÑĞ²Ğ°Ñ€Ğ¸"];
    
    for (const word of badWords) {
        if (text.includes(word)) {
            console.error(`ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰Ñ‘Ğ½Ğ½Ğ¾Ğµ ÑĞ»Ğ¾Ğ²Ğ¾: ${word}`);
            return false;
        }
    }
    
    data.subtitle = data.subtitle || "Ğ Ğ°Ğ·Ğ²Ğ¸Ğ²Ğ°ÑÑ‰Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ";
    data.motivation = data.motivation || "ĞœĞ¾Ğ»Ğ¾Ğ´ĞµÑ†! Ğ¢Ñ‹ ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑÑ! â­";
    
    data.tasks.forEach((task, i) => {
        task.level = task.level || LEVEL_ICONS[i] || "â­";
        task.level_name = task.level_name || LEVEL_NAMES[i] || `Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ ${i + 1}`;
        task.elements = task.elements || [];
        task.answers = task.answers || [];
        task.content = task.content || "";
        task.instruction = task.instruction || "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ";
    });
    
    return true;
}