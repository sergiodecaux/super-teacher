// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const API_URL = "/api/groq";

const MODELS = [
    "llama-3.1-70b-versatile",
    "llama-3.1-8b-instant"
];

// ĞĞ¸Ğ·ĞºĞ°Ñ Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° = Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ³Ğ°Ğ»Ğ»ÑÑ†Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¹
const TEMPERATURE = 0.5;


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞĞ«Ğ™ ĞŸĞ ĞĞœĞŸĞ¢ (Ğ¶Ñ‘ÑÑ‚ĞºĞ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `Ğ¢Ñ‹ â€” Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¸ÑÑ‚ Ğ¸ ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ĞºĞ»Ğ°ÑÑĞ¾Ğ² Ğ² Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¾Ğ¹ ÑˆĞºĞ¾Ğ»Ğµ.

Ğ–Ğ•Ğ›Ğ•Ğ—ĞĞ«Ğ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ:
1. Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ğ¡Ğ¢Ğ ĞĞ“Ğ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ñ‚ĞµĞ¼Ğµ. ĞĞ˜ĞšĞĞ“Ğ”Ğ Ğ½Ğµ ÑĞ¼ĞµÑˆĞ¸Ğ²Ğ°Ğ¹ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ñ‹.
2. Ğ•ÑĞ»Ğ¸ Ñ‚ĞµĞ¼Ğ° "Ğ¡ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ" â€” Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾ ÑĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ. Ğ•ÑĞ»Ğ¸ "Ğ¡Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ" â€” Ğ²ÑĞµ Ğ¿Ñ€Ğ¾ ÑĞ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ.
3. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ JSON. ĞĞ¸ĞºĞ°ĞºĞ¾Ğ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ´Ğ¾ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ÑĞ»Ğµ JSON.
4. ĞĞ¸ĞºĞ°ĞºĞ¾Ğ³Ğ¾ markdown (Ğ±ĞµĞ· \`\`\`json). Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¹ JSON.
5. ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚Ñƒ Ğ¸ Ğ¤Ğ“ĞĞ¡ Ğ Ğ¾ÑÑĞ¸Ğ¸.

Ğ’ĞĞ—Ğ ĞĞ¡Ğ¢ĞĞ«Ğ• ĞĞ¡ĞĞ‘Ğ•ĞĞĞĞ¡Ğ¢Ğ˜:
- Ğ”Ğ¾ÑˆĞºĞ¾Ğ»ÑŒĞ½Ğ¸ĞºĞ¸ (5-6 Ğ»ĞµÑ‚): Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°, ÑÑ‡Ñ‘Ñ‚ Ğ´Ğ¾ 10
- 1 ĞºĞ»Ğ°ÑÑ (6-7 Ğ»ĞµÑ‚): Ğ±ÑƒĞºĞ²Ñ‹, ÑĞ»Ğ¾Ğ³Ğ¸, Ñ‡Ğ¸ÑĞ»Ğ° Ğ´Ğ¾ 20
- 2 ĞºĞ»Ğ°ÑÑ (7-8 Ğ»ĞµÑ‚): Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, Ñ‡Ğ¸ÑĞ»Ğ° Ğ´Ğ¾ 100
- 3 ĞºĞ»Ğ°ÑÑ (8-9 Ğ»ĞµÑ‚): ÑĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ, Ğ¿Ğ°Ğ´ĞµĞ¶Ğ¸, ÑƒĞ¼Ğ½Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ/Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ
- 4 ĞºĞ»Ğ°ÑÑ (9-10 Ğ»ĞµÑ‚): ÑĞ¿Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ, ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğµ Ñ‡Ğ¸ÑĞ»Ğ°

Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•ĞĞ:
- Ğ¡Ğ¼ĞµÑˆĞ¸Ğ²Ğ°Ñ‚ÑŒ Ñ‚ĞµĞ¼Ñ‹ (Ğ¼Ğ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸ĞºĞ° + Ñ€ÑƒÑÑĞºĞ¸Ğ¹)
- Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±ĞµÑÑĞ¼Ñ‹ÑĞ»ĞµĞ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ»Ğ¾Ğ²Ğ°: ĞºÑƒĞ¿Ğ¸, ÑÑ…Ğ¾Ğ´Ğ¸, Ğ²Ğ¸Ğ´ĞµĞ¾, Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚
- Ğ”Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ±ÑÑ‚Ñ€Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ±ĞµĞ· ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°`;


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¨ĞĞ‘Ğ›ĞĞĞ« ĞŸĞ ĞĞœĞŸĞ¢ĞĞ’ ĞŸĞ ĞŸĞ Ğ•Ğ”ĞœĞ•Ğ¢ĞĞœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SUBJECT_PROMPTS = {
    russian: {
        "ÑĞºĞ»Ğ¾Ğ½ĞµĞ½": `Ğ¢ĞµĞ¼Ğ°: Ğ¡ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ….
Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸ ÑĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ" â€” Ğ´Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑĞ»Ğ¾Ğ², ÑƒÑ‡ĞµĞ½Ğ¸Ğº Ğ¿Ğ¸ÑˆĞµÑ‚ 1/2/3 ÑĞºĞ».
2. "Ğ—Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ğ² Ñ‚Ñ€Ğ¸ ÑÑ‚Ğ¾Ğ»Ğ±Ğ¸ĞºĞ°" â€” Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ ÑĞ»Ğ¾Ğ²Ğ° Ğ¿Ğ¾ ÑĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸ÑĞ¼
3. "ĞĞ±Ñ€Ğ°Ğ·ÑƒĞ¹ ÑĞ»Ğ¾Ğ²Ğ¾ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ ÑĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ñ" â€” Ğ¼Ğ°Ğ¼Ğ°â†’Ğ¼Ğ°Ñ‚ÑŒ, Ğ¿Ğ°Ğ¿Ğ°â†’Ğ¾Ñ‚ĞµÑ†
ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ ÑĞ»Ğ¾Ğ²: Ğ·ĞµĞ¼Ğ»Ñ, ĞºĞ¾Ğ½ÑŒ, Ğ½Ğ¾Ñ‡ÑŒ, Ğ´ÑĞ´Ñ, Ğ¼Ğ¾Ñ€Ğµ, ÑÑ‚ĞµĞ¿ÑŒ, Ğ¾ĞºĞ½Ğ¾, Ğ¼Ñ‹ÑˆÑŒ`,

        "Ğ¿Ğ°Ğ´ĞµĞ¶": `Ğ¢ĞµĞ¼Ğ°: ĞŸĞ°Ğ´ĞµĞ¶Ğ¸ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ….
Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸ Ğ¿Ğ°Ğ´ĞµĞ¶" â€” Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ñ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ½Ñ‹Ğ¼ ÑĞ»Ğ¾Ğ²Ğ¾Ğ¼
2. "ĞŸĞ¾ÑÑ‚Ğ°Ğ²ÑŒ Ğ² Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ğ´ĞµĞ¶" â€” ÑĞ»Ğ¾Ğ²Ğ¾ Ğ² ÑĞºĞ¾Ğ±ĞºĞ°Ñ… Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ
3. "Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ ÑĞ»Ğ¾Ğ²Ğ¾ÑĞ¾Ñ‡ĞµÑ‚Ğ°Ğ½Ğ¸Ğµ" â€” Ğ´Ğ°Ğ½Ğ¾ ÑĞ»Ğ¾Ğ²Ğ¾ + Ğ¿Ğ°Ğ´ĞµĞ¶
ĞŸĞ°Ğ´ĞµĞ¶Ğ¸: Ğ˜.Ğ¿.(ĞºÑ‚Ğ¾?Ñ‡Ñ‚Ğ¾?), Ğ .Ğ¿.(ĞºĞ¾Ğ³Ğ¾?Ñ‡ĞµĞ³Ğ¾?), Ğ”.Ğ¿.(ĞºĞ¾Ğ¼Ñƒ?Ñ‡ĞµĞ¼Ñƒ?), Ğ’.Ğ¿.(ĞºĞ¾Ğ³Ğ¾?Ñ‡Ñ‚Ğ¾?), Ğ¢.Ğ¿.(ĞºĞµĞ¼?Ñ‡ĞµĞ¼?), ĞŸ.Ğ¿.(Ğ¾ ĞºĞ¾Ğ¼?Ğ¾ Ñ‡Ñ‘Ğ¼?)`,

        "Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½": `Ğ¢ĞµĞ¼Ğ°: ĞĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ….
Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "Ğ’ÑÑ‚Ğ°Ğ²ÑŒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ" â€” ÑĞ»Ğ¾Ğ²Ğ¾ Ñ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ¾Ğ¼: Ğ½Ğ° Ğ¿Ğ°Ñ€Ñ‚_, Ñƒ Ğ´Ğ¾Ñ€Ğ¾Ğ³_
2. "Ğ• Ğ¸Ğ»Ğ¸ Ğ˜?" â€” Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ
3. "Ğ¡Ğ¿Ğ¸ÑˆĞ¸, Ğ²ÑÑ‚Ğ°Ğ²Ğ¸Ğ² Ğ±ÑƒĞºĞ²Ñ‹" â€” Ñ‚ĞµĞºÑÑ‚ Ñ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°Ğ¼Ğ¸
ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ°: 1ÑĞºĞ» Ğ .Ğ¿.=-Ğ¸, Ğ”.Ğ¿.=-Ğµ, ĞŸ.Ğ¿.=-Ğµ; 3ÑĞºĞ» Ğ .Ğ¿.,Ğ”.Ğ¿.,ĞŸ.Ğ¿.=-Ğ¸`,

        "ÑĞ¿Ñ€ÑĞ¶ĞµĞ½": `Ğ¢ĞµĞ¼Ğ°: Ğ¡Ğ¿Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ Ğ³Ğ»Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ².
Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸ ÑĞ¿Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ" â€” ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ³Ğ»Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ² Ğ½ĞµĞ¾Ğ¿Ñ€.Ñ„Ğ¾Ñ€Ğ¼Ñ‹
2. "Ğ’ÑÑ‚Ğ°Ğ²ÑŒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ" â€” Ğ¾Ğ½ Ñ‡Ğ¸Ñ‚Ğ°_Ñ‚, Ğ¾Ğ½Ğ¸ Ğ³Ğ¾Ğ²Ğ¾Ñ€_Ñ‚
3. "Ğ“Ğ»Ğ°Ğ³Ğ¾Ğ»Ñ‹-Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ" â€” Ğ³Ğ½Ğ°Ñ‚ÑŒ, Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ, Ğ´Ñ‹ÑˆĞ°Ñ‚ÑŒ, ÑĞ»Ñ‹ÑˆĞ°Ñ‚ÑŒ, Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ, Ğ½ĞµĞ½Ğ°Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ, ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ, Ğ²ĞµÑ€Ñ‚ĞµÑ‚ÑŒ, Ğ¾Ğ±Ğ¸Ğ´ĞµÑ‚ÑŒ, Ğ·Ğ°Ğ²Ğ¸ÑĞµÑ‚ÑŒ, Ñ‚ĞµÑ€Ğ¿ĞµÑ‚ÑŒ
I ÑĞ¿Ñ€.: -ĞµÑˆÑŒ,-ĞµÑ‚,-ĞµĞ¼,-ĞµÑ‚Ğµ,-ÑƒÑ‚/ÑÑ‚; II ÑĞ¿Ñ€.: -Ğ¸ÑˆÑŒ,-Ğ¸Ñ‚,-Ğ¸Ğ¼,-Ğ¸Ñ‚Ğµ,-Ğ°Ñ‚/ÑÑ‚`,

        "Ğ±ĞµĞ·ÑƒĞ´Ğ°Ñ€Ğ½": `Ğ¢ĞµĞ¼Ğ°: Ğ‘ĞµĞ·ÑƒĞ´Ğ°Ñ€Ğ½Ñ‹Ğµ Ğ³Ğ»Ğ°ÑĞ½Ñ‹Ğµ.
Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "Ğ’ÑÑ‚Ğ°Ğ²ÑŒ Ğ±ÑƒĞºĞ²Ñƒ" â€” Ğ²_Ğ´Ğ°, Ñ‚Ñ€_Ğ²Ğ°, Ğ³_Ñ€Ğ° (Ğ¾/Ğ°)
2. "ĞŸĞ¾Ğ´Ğ±ĞµÑ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ñ‡Ğ½Ğ¾Ğµ ÑĞ»Ğ¾Ğ²Ğ¾" â€” Ğ²Ğ¾Ğ´Ğ°-Ğ²Ğ¾Ğ´Ñ‹
3. "ĞĞ°Ğ¹Ğ´Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ" â€” ĞºĞ°Ñ€Ğ¾Ğ²Ğ°, ÑĞ°Ğ±Ğ°ĞºĞ° â†’ ĞºĞ¾Ñ€Ğ¾Ğ²Ğ°, ÑĞ¾Ğ±Ğ°ĞºĞ°`,

        "default": `Ğ¢ĞµĞ¼Ğ°: Ğ ÑƒÑÑĞºĞ¸Ğ¹ ÑĞ·Ñ‹Ğº.
Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ ÑĞ¾ ÑĞ»Ğ¾Ğ²Ğ°Ğ¼Ğ¸: Ğ²ÑÑ‚Ğ°Ğ²ÑŒ Ğ±ÑƒĞºĞ²Ñƒ, Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¸ Ğ½Ğ° ÑĞ»Ğ¾Ğ³Ğ¸, Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ ÑƒĞ´Ğ°Ñ€ĞµĞ½Ğ¸Ğµ, Ğ½Ğ°Ğ¹Ğ´Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ.`
    },

    math: {
        "ÑĞ»Ğ¾Ğ¶ĞµĞ½|Ğ²Ñ‹Ñ‡Ğ¸Ñ‚Ğ°Ğ½": `Ğ¢ĞµĞ¼Ğ°: Ğ¡Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ²Ñ‹Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ.
Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "Ğ ĞµÑˆĞ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹" â€” 24+18=, 56-29=
2. "Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸" â€” 45â—‹38 (Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ >,<,=)
3. "ĞĞ°Ğ¹Ğ´Ğ¸ Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğµ" â€” 24+?=61
Ğ§Ğ¸ÑĞ»Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ»Ğ°ÑÑÑƒ!`,

        "ÑƒĞ¼Ğ½Ğ¾Ğ¶ĞµĞ½|Ğ´ĞµĞ»ĞµĞ½|Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†": `Ğ¢ĞµĞ¼Ğ°: Ğ£Ğ¼Ğ½Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ.
Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "Ğ ĞµÑˆĞ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹" â€” 6Ã—7=, 48:8=
2. "ĞĞ°Ğ¹Ğ´Ğ¸ Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğµ" â€” ?Ã—6=42
3. "Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸" â€” 7Ã—8â—‹50
Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ ÑƒĞ¼Ğ½Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ¾ 9Ã—9`,

        "ÑƒÑ€Ğ°Ğ²Ğ½ĞµĞ½": `Ğ¢ĞµĞ¼Ğ°: Ğ£Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ.
Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "Ğ ĞµÑˆĞ¸ ÑƒÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ" â€” x+24=61, 85-x=37
2. "Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ ÑƒÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ" â€” Ğ¿Ğ¾ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
Ğ§Ğ¸ÑĞ»Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¼Ğ¸ Ğ´Ğ»Ñ ĞºĞ»Ğ°ÑÑĞ°!`,

        "Ğ·Ğ°Ğ´Ğ°Ñ‡": `Ğ¢ĞµĞ¼Ğ°: Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸.
Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ñ ÑƒÑĞ»Ğ¾Ğ²Ğ¸ĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ¼.
Ğ¡ÑĞ¶ĞµÑ‚Ñ‹: ÑˆĞºĞ¾Ğ»Ğ°, Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½, Ğ¿Ñ€Ğ¸Ñ€Ğ¾Ğ´Ğ°, ÑĞµĞ¼ÑŒÑ.
Ğ§Ğ¸ÑĞ»Ğ° ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚ ĞºĞ»Ğ°ÑÑÑƒ.`,

        "default": `Ğ¢ĞµĞ¼Ğ°: ĞœĞ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸ĞºĞ°.
Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ½Ğ° Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ, ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ ĞºĞ»Ğ°ÑÑÑƒ.`
    },

    reading: {
        "default": `Ğ¢ĞµĞ¼Ğ°: Ğ›Ğ¸Ñ‚ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ.
Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½Ğ¸ Ğ³ĞµÑ€Ğ¾Ñ Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ"
2. "Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹"
3. "ĞšÑ‚Ğ¾ ÑÑ‚Ğ¾ ÑĞºĞ°Ğ·Ğ°Ğ»?" â€” Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ğ° Ğ³ĞµÑ€Ğ¾Ñ
4. "ĞŸĞ¾Ğ´Ğ±ĞµÑ€Ğ¸ Ğ¿Ğ¾ÑĞ»Ğ¾Ğ²Ğ¸Ñ†Ñƒ Ğº ÑĞºĞ°Ğ·ĞºĞµ"
Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ¸Ğ· ÑˆĞºĞ¾Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Ğ Ğ¾ÑÑĞ¸Ğ¸.`
    },

    logic: {
        "default": `Ğ¢ĞµĞ¼Ğ°: Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°.
Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "ĞĞ°Ğ¹Ğ´Ğ¸ Ğ»Ğ¸ÑˆĞ½ĞµĞµ" â€” ĞºĞ¾ÑˆĞºĞ°, ÑĞ¾Ğ±Ğ°ĞºĞ°, ÑÑ‚Ğ¾Ğ», Ñ…Ğ¾Ğ¼ÑĞº (ÑÑ‚Ğ¾Ğ» â€” Ğ½Ğµ Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ğ¾Ğµ)
2. "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸ Ñ€ÑĞ´" â€” 2, 4, 6, 8, ?
3. "ĞĞ°Ğ¹Ğ´Ğ¸ Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾ÑÑ‚ÑŒ"`
    },

    world: {
        "default": `Ğ¢ĞµĞ¼Ğ°: ĞĞºÑ€ÑƒĞ¶Ğ°ÑÑ‰Ğ¸Ğ¹ Ğ¼Ğ¸Ñ€.
Ğ¢Ğ¸Ğ¿Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:
1. "Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸ Ğ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹" â€” Ğ¶Ğ¸Ğ²Ğ¾Ğµ/Ğ½ĞµĞ¶Ğ¸Ğ²Ğ¾Ğµ, Ğ´Ğ¸ĞºĞ¸Ğµ/Ğ´Ğ¾Ğ¼Ğ°ÑˆĞ½Ğ¸Ğµ
2. "Ğ’ĞµÑ€Ğ½Ğ¾/Ğ½ĞµĞ²ĞµÑ€Ğ½Ğ¾" â€” Ñ„Ğ°ĞºÑ‚Ñ‹ Ğ¾ Ğ¿Ñ€Ğ¸Ñ€Ğ¾Ğ´Ğµ
3. "Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½Ğ¸" â€” Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ğ¾Ğµ Ğ¸ ĞµĞ³Ğ¾ Ğ¶Ğ¸Ğ»Ğ¸Ñ‰Ğµ`
    },

    english: {
        "default": `Topic: English Language.
Task types:
1. "Translate" â€” ÑĞ»Ğ¾Ğ²Ğ¾/Ñ„Ñ€Ğ°Ğ·Ğ° Ğ½Ğ° Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´
2. "Fill in the gaps" â€” Ğ²ÑÑ‚Ğ°Ğ²ÑŒ Ğ±ÑƒĞºĞ²Ñƒ/ÑĞ»Ğ¾Ğ²Ğ¾
3. "Match" â€” ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸ ÑĞ»Ğ¾Ğ²Ğ¾ Ğ¸ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºÑƒ/Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´
Vocabulary must be appropriate for the grade level.`
    }
};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞŸĞĞ¡Ğ¢Ğ ĞĞ•ĞĞ˜Ğ• ĞŸĞ ĞĞœĞŸĞ¢Ğ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buildPrompt(userRequest) {
    // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚ Ğ¸ Ñ‚ĞµĞ¼Ñƒ Ğ¸Ğ· Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
    const requestLower = userRequest.toLowerCase();
    
    let subjectKey = "russian"; // Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
    let subjectPrompt = "";
    
    // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚
    if (/Ğ¼Ğ°Ñ‚ĞµĞ¼Ğ°Ñ‚|ÑĞ»Ğ¾Ğ¶ĞµĞ½|Ğ²Ñ‹Ñ‡Ğ¸Ñ‚Ğ°Ğ½|ÑƒĞ¼Ğ½Ğ¾Ğ¶ĞµĞ½|Ğ´ĞµĞ»ĞµĞ½|Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€|Ğ·Ğ°Ğ´Ğ°Ñ‡|ÑƒÑ€Ğ°Ğ²Ğ½ĞµĞ½/.test(requestLower)) {
        subjectKey = "math";
    } else if (/Ñ‡Ñ‚ĞµĞ½|Ğ»Ğ¸Ñ‚ĞµÑ€Ğ°Ñ‚ÑƒÑ€|ÑĞºĞ°Ğ·Ğº|Ñ€Ğ°ÑÑĞºĞ°Ğ·|ÑÑ‚Ğ¸Ñ…|Ğ±Ğ°ÑĞ½/.test(requestLower)) {
        subjectKey = "reading";
    } else if (/Ğ»Ğ¾Ğ³Ğ¸Ğº|Ğ»Ğ¸ÑˆĞ½|Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½/.test(requestLower)) {
        subjectKey = "logic";
    } else if (/Ğ¾ĞºÑ€ÑƒĞ¶|Ğ¿Ñ€Ğ¸Ñ€Ğ¾Ğ´|Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½|Ñ€Ğ°ÑÑ‚ĞµĞ½/.test(requestLower)) {
        subjectKey = "world";
    } else if (/Ğ°Ğ½Ğ³Ğ»|english/.test(requestLower)) {
        subjectKey = "english";
    }
    
    // Ğ˜Ñ‰ĞµĞ¼ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½ÑƒÑ Ñ‚ĞµĞ¼Ñƒ
    const subjectTemplates = SUBJECT_PROMPTS[subjectKey];
    for (const [pattern, prompt] of Object.entries(subjectTemplates)) {
        if (pattern === "default") continue;
        if (new RegExp(pattern, 'i').test(requestLower)) {
            subjectPrompt = prompt;
            break;
        }
    }
    
    // Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°ÑˆĞ»Ğ¸ â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ default
    if (!subjectPrompt) {
        subjectPrompt = subjectTemplates["default"];
    }

    return `Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ»Ğ¸ÑÑ‚.

Ğ—ĞĞŸĞ ĞĞ¡ Ğ£Ğ§Ğ˜Ğ¢Ğ•Ğ›Ğ¯: ${userRequest}

ĞœĞ•Ğ¢ĞĞ”Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ• Ğ£ĞšĞĞ—ĞĞĞ˜Ğ¯:
${subjectPrompt}

Ğ¢Ğ Ğ•Ğ‘ĞĞ’ĞĞĞ˜Ğ¯ Ğš JSON:
{
  "worksheet_title": "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚ĞµĞ¼Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°)",
  "subject": "ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚ (Ğ ÑƒÑÑĞºĞ¸Ğ¹ ÑĞ·Ñ‹Ğº / ĞœĞ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸ĞºĞ° / Ğ¸ Ñ‚.Ğ´.)",
  "grade": "ĞšĞ»Ğ°ÑÑ",
  "tasks": [
    {
      "id": 1,
      "task_type": "determine | fill_gaps | transform | group | solve | compare",
      "instruction": "Ğ§Ñ‘Ñ‚ĞºĞ°Ñ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ ÑƒÑ‡ĞµĞ½Ğ¸ĞºÑƒ (ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸..., Ğ’ÑÑ‚Ğ°Ğ²ÑŒ..., Ğ—Ğ°Ğ¿Ğ¸ÑˆĞ¸...)",
      "content": "ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ» Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ (ÑĞ»Ğ¾Ğ²Ğ°, Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ, Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹)",
      "items": ["ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚1", "ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚2", "..."],
      "correct_answers": ["Ğ¾Ñ‚Ğ²ĞµÑ‚1", "Ğ¾Ñ‚Ğ²ĞµÑ‚2", "..."]
    }
  ],
  "total_tasks": 5
}

ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ:
1. worksheet_title Ğ”ĞĞ›Ğ–Ğ•Ğ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚ĞµĞ¼Ğµ "${userRequest}"
2. Ğ’ÑĞµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¿Ğ¾ ÑÑ‚Ğ¾Ğ¹ Ñ‚ĞµĞ¼Ğµ
3. items Ğ¸ correct_answers Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ¸Ğ¼ĞµÑ‚ÑŒ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²ÑƒÑ Ğ´Ğ»Ğ¸Ğ½Ñƒ
4. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ JSON, Ğ±ĞµĞ· Ñ‚ĞµĞºÑÑ‚Ğ° Ğ´Ğ¾/Ğ¿Ğ¾ÑĞ»Ğµ`;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ’Ğ«Ğ—ĞĞ’ API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callGroqAI(userRequest, apiKey) {
    let lastError = null;
    
    for (const model of MODELS) {
        try {
            console.log(`ğŸ”„ ĞœĞ¾Ğ´ĞµĞ»ÑŒ: ${model}`);
            console.log(`ğŸ“ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ: ${userRequest}`);
            
            const response = await fetch(API_URL, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${apiKey}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: "system", content: SYSTEM_PROMPT },
                        { role: "user", content: buildPrompt(userRequest) }
                    ],
                    max_tokens: 4000,
                    temperature: TEMPERATURE
                })
            });
            
            if (response.status === 429) {
                console.log("âš ï¸ Ğ›Ğ¸Ğ¼Ğ¸Ñ‚, ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ...");
                await new Promise(r => setTimeout(r, 1000));
                continue;
            }
            
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            const text = data.choices?.[0]?.message?.content;
            
            if (!text) {
                console.log("âš ï¸ ĞŸÑƒÑÑ‚Ğ¾Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚");
                continue;
            }
            
            console.log(`âœ… ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ ${text.length} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²`);
            
            // ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµĞ¼
            const worksheet = parseAndValidate(text, userRequest);
            if (worksheet) {
                return worksheet;
            }
            
        } catch (error) {
            console.error(`âŒ ${model}:`, error.message);
            lastError = error;
            continue;
        }
    }
    
    throw new Error(lastError?.message || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·.");
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞŸĞĞ Ğ¡Ğ˜ĞĞ“ Ğ˜ Ğ’ĞĞ›Ğ˜Ğ”ĞĞ¦Ğ˜Ğ¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function parseAndValidate(text, originalRequest) {
    // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ JSON
    const json = extractJSON(text);
    if (!json) return null;
    
    // Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹
    if (!json.worksheet_title || !json.tasks || !Array.isArray(json.tasks)) {
        console.error("âŒ ĞĞµĞ²ĞµÑ€Ğ½Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° JSON");
        return null;
    }
    
    if (json.tasks.length < 3) {
        console.error("âŒ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ°Ğ»Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹");
        return null;
    }
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ñ Ñ‚ĞµĞ¼Ğµ
    const requestLower = originalRequest.toLowerCase();
    const titleLower = json.worksheet_title.toLowerCase();
    
    // Ğ•ÑĞ»Ğ¸ Ğ² Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ "ÑĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ", Ğ° Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ "ÑĞ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ" â€” ÑÑ‚Ğ¾ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°
    if (requestLower.includes("ÑĞºĞ»Ğ¾Ğ½ĞµĞ½") && titleLower.includes("ÑĞ»Ğ¾Ğ¶ĞµĞ½")) {
        console.error("âŒ ĞĞµÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ñ‚ĞµĞ¼Ñ‹: Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ñ€Ğ¾ ÑĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ, Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¿Ñ€Ğ¾ ÑĞ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ");
        return null;
    }
    if (requestLower.includes("Ğ¿Ğ°Ğ´ĞµĞ¶") && !titleLower.includes("Ğ¿Ğ°Ğ´ĞµĞ¶")) {
        console.warn("âš ï¸ Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾Ğµ Ğ½ĞµÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ñ‚ĞµĞ¼Ñ‹ Ğ¿Ğ°Ğ´ĞµĞ¶ĞµĞ¹");
    }
    
    // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ² Ğ½Ğ°Ñˆ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚
    return convertToWorksheet(json);
}


function extractJSON(text) {
    // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ markdown
    text = text.replace(/```json\s*/gi, "");
    text = text.replace(/```\s*/gi, "");
    text = text.trim();
    
    // Ğ˜Ñ‰ĞµĞ¼ JSON
    const match = text.match(/\{[\s\S]*\}/);
    if (!match) {
        console.error("âŒ JSON Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ");
        return null;
    }
    
    try {
        let jsonStr = match[0];
        // Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
        jsonStr = jsonStr.replace(/,\s*}/g, "}");
        jsonStr = jsonStr.replace(/,\s*]/g, "]");
        jsonStr = jsonStr.replace(/[\r\n]+/g, " ");
        
        return JSON.parse(jsonStr);
    } catch (e) {
        console.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° JSON:", e.message);
        return null;
    }
}


function convertToWorksheet(json) {
    // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ UI
    const levels = ["â­", "â­â­", "â­â­â­", "â­â­â­â­", "â­â­â­â­â­"];
    const levelNames = ["Ğ Ğ°Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°", "Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°", "Ğ—Ğ°ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¸Ğµ", "Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾Ğµ", "Ğ”Ğ»Ñ Ğ·Ğ½Ğ°Ñ‚Ğ¾ĞºĞ¾Ğ²"];
    
    const tasks = json.tasks.map((task, i) => {
        // ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ items
        let elements = task.items || task.elements || [];
        if (typeof elements === 'string') elements = [elements];
        if (!Array.isArray(elements)) elements = [];
        
        // Ğ•ÑĞ»Ğ¸ items Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹, Ğ½Ğ¾ ĞµÑÑ‚ÑŒ content â€” Ñ€Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµĞ¼ content
        if (elements.length === 0 && task.content) {
            // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ±Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ Ğ·Ğ°Ğ¿ÑÑ‚Ñ‹Ğ¼ Ğ¸Ğ»Ğ¸ Ñ‚Ğ¾Ñ‡ĞºĞ°Ğ¼
            const split = task.content.split(/[,;.]\s*/).filter(s => s.trim());
            if (split.length > 1) {
                elements = split;
            } else {
                elements = [task.content];
            }
        }
        
        // ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ answers
        let answers = task.correct_answers || task.answers || [];
        if (typeof answers === 'string') answers = [answers];
        if (!Array.isArray(answers)) answers = [];
        
        return {
            level: levels[i] || "â­",
            level_name: task.task_type ? formatTaskType(task.task_type) : levelNames[i] || `ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° ${i + 1}`,
            instruction: task.instruction || "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ.",
            content: task.content || "",
            elements: elements.map(e => String(e).trim()).filter(e => e),
            answers: answers.map(a => String(a).trim()).filter(a => a)
        };
    });
    
    // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ
    const validTasks = tasks.filter(t => t.elements.length > 0 || t.content);
    
    if (validTasks.length < 3) {
        console.error("âŒ ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ¼Ğ°Ğ»Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹");
        return null;
    }
    
    return {
        title: json.worksheet_title || "Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ»Ğ¸ÑÑ‚",
        subtitle: json.subject ? `${json.subject}, ${json.grade || ""}` : "Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ°Ğ¼Ğ¾ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹",
        tasks: validTasks,
        motivation: "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! Ğ¢Ñ‹ ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑÑ ÑĞ¾ Ğ²ÑĞµĞ¼Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸ÑĞ¼Ğ¸! â­"
    };
}


function formatTaskType(type) {
    const types = {
        "determine": "ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸",
        "fill_gaps": "Ğ’ÑÑ‚Ğ°Ğ²ÑŒ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ¸",
        "transform": "ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞ¹",
        "group": "Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸",
        "solve": "Ğ ĞµÑˆĞ¸",
        "compare": "Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸",
        "match": "Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½Ğ¸",
        "order": "Ğ Ğ°ÑÑÑ‚Ğ°Ğ²ÑŒ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº"
    };
    return types[type] || type;
}